<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text Editor</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #f4f4f4;
      }

      .editor {
        width: 90%;
        max-width: 600px;
        background: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin: 0 auto;
      }

      .editor textarea {
        width: calc(100% - 20px);
        height: 300px;
        font-size: 16px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: none;
        box-sizing: border-box;
      }

      .buttons {
        display: none;
        justify-content: space-between;
        margin-top: 15px;
      }

      button {
        padding: 10px 15px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .save-btn {
        background-color: #28a745;
        color: white;
      }

      .save-btn:hover {
        background-color: #218838;
      }

      .cancel-btn {
        background-color: #dc3545;
        color: white;
      }

      .cancel-btn:hover {
        background-color: #c82333;
      }

      .back-btn {
        background-color: #007bff;
        color: white;
      }

      .back-btn:hover {
        background-color: #0056b3;
      }

      .copy-warning {
        color: red;
        font-size: 14px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="editor">
      <h2>Text Editor</h2>
      <textarea id="textEditor" readonly></textarea>
      <div class="buttons">
        <button id="saveButton" class="save-btn" disabled>Save</button>
        <button id="cancelButton" class="cancel-btn" disabled>Cancel</button>
      </div>
      <input type="file" id="fileInput" style="display: none" accept=".txt" />
      <button id="fileButton">Choose File</button>
      <button id="backButton" class="back-btn">Back</button>
      <p id="copyWarning" class="copy-warning">Copying is not allowed.</p>
    </div>

    <script>
      const { ipcRenderer } = require('electron');
      const fs = require('fs');

      let currentFilePath = '';
      let accessRights = '';

      const textEditor = document.getElementById('textEditor');
      const saveButton = document.getElementById('saveButton');
      const cancelButton = document.getElementById('cancelButton');
      const backButton = document.getElementById('backButton');
      const fileButton = document.getElementById('fileButton');
      const fileInput = document.getElementById('fileInput');
      const buttonsContainer = document.querySelector('.buttons');
      const copyWarning = document.getElementById('copyWarning');

      fileButton.addEventListener('click', function () {
        fileInput.click();
      });

      fileInput.addEventListener('change', function () {
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];

          if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            const reader = new FileReader();

            reader.onload = function (e) {
              textEditor.value = e.target.result;
              currentFilePath = file.name;
              getAccessRights(currentFilePath);
            };

            reader.readAsText(file);
          } else {
            alert('Please select a text file.');
          }
        }
      });

      function getAccessRights(filename) {
        ipcRenderer.send('get-user-rights-on-file', filename);
      }

      ipcRenderer.on('get-user-rights-on-file-response', (event, response) => {
        if (
          !response ||
          !['READ', 'READ_COPY', 'READ_WRITE_COPY'].includes(response)
        ) {
          accessRights = 'READ';
        } else {
          accessRights = response;
        }
        applyAccessRights();
      });

      function applyAccessRights() {
        if (accessRights === 'READ') {
          textEditor.readOnly = true;
          buttonsContainer.style.display = 'none';
          textEditor.addEventListener('copy', preventCopy);
          copyWarning.style.display = 'block';
        } else if (accessRights === 'READ_COPY') {
          textEditor.readOnly = true;
          buttonsContainer.style.display = 'none';
          textEditor.removeEventListener('copy', preventCopy);
          copyWarning.style.display = 'none';
        } else if (accessRights === 'READ_WRITE_COPY') {
          textEditor.readOnly = false;
          buttonsContainer.style.display = 'flex';
          textEditor.removeEventListener('copy', preventCopy);
          copyWarning.style.display = 'none';
        }

        saveButton.disabled = !currentFilePath;
        cancelButton.disabled = !currentFilePath;
      }

      function preventCopy(e) {
        e.preventDefault();
        e.clipboardData.setData('text/plain', 'Copying is not allowed!');
        copyWarning.style.display = 'block';
      }

      saveButton.addEventListener('click', () => {
        if (currentFilePath) {
          fs.writeFile(currentFilePath, textEditor.value, (err) => {
            if (err) {
              alert('Error saving the file: ' + err);
            } else {
              alert('File saved: ' + currentFilePath);
            }
          });
        } else {
          alert('No file selected.');
        }
      });

      cancelButton.addEventListener('click', () => {
        textEditor.value = '';
        textEditor.readOnly = true;
        hideButtons();
        currentFilePath = '';
        fileInput.value = '';
      });

      backButton.addEventListener('click', () => {
        ipcRenderer.send('open-main-auth');
      });

      function hideButtons() {
        buttonsContainer.style.display = 'none';
        saveButton.disabled = true;
        cancelButton.disabled = true;
      }
    </script>
  </body>
</html>
